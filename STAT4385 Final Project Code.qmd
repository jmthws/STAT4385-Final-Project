---
title: "STAT4385 Final Project Code"
author: "Joseph Mathews"
format: html
editor: visual
---

```{r libs}
#| include: false
library(tidyverse)
library(coin)
library(purrr)
library(ggplot2)
library(patchwork)
```

```{r kwsim}
#| include: false
simulate_kw <- function(n = 500) {

  # Generate Group A from a Normal distribution.
  # This serves as a baseline distribution for reference.
  A <- rnorm(n)

  # Generate Group B from a Lognormal distribution.
  # The raw Lognormal values have a higher median than Group A.
  B_raw <- rlnorm(n)

  # We shift Group B so that its median matches that of Group A.
  B <- B_raw - median(B_raw) + median(A)

  # Generate Group C from a t-distribution with 3 degrees of freedom.
  # The distribution is symmetric but has heavy tails.
  C_raw <- rt(n, df = 3)

  # Again, here we shift Group C so that its median also matches that of Group A.
  C <- C_raw - median(C_raw) + median(A)

  # Combines all observations into a single data frame "groups".
  groups <- data.frame(
    value = c(A, B, C),
    group = factor(rep(c("A", "B", "C"), each = n))
  )
  
  kw <- kruskal.test(value ~ group, data = groups)
  return(kw$p.value)
}
```

```{r gen}
#| include: false
groups_func <- function(n = 500) {
  A <- rnorm(n)
  B_raw <- rlnorm(n)
  B <- B_raw - median(B_raw) + median(A)
  C_raw <- rt(n, df = 3)
  C <- C_raw - median(C_raw) + median(A)
  
  data.frame(
    value = c(A, B, C),
    group = factor(rep(c("A", "B", "C"), each = n))
  )
}
```

```{r plots}
#| echo: false
#violin plot
set.seed(2003)
groups <- groups_func(n = 500)

library(ggplot2)
ggplot(groups, aes(x = group, y = value, fill = group)) +
  geom_violin(trim = FALSE, alpha = 0.7) +
  geom_boxplot(width = 0.15, outlier.alpha = 0) +
    labs(
    title = "Distribution Shapes: Normal vs. Lognormal vs. Heavy-Tailed t",
    subtitle = "Equalized medians but notable differences in skewness and tail behavior"
  ) +
  theme_minimal()
```

``` {r ecdf}
#| echo: false
ggplot(groups, aes(value, color = group)) +
  stat_ecdf(lwd = 1) +
  labs(
    title = "Empirical CDFs",
    subtitle = "Equalized medians but notable differences in skewness and tail behavior"
  ) +
  theme_minimal()
```

```{r genpvals}
#| echo: false
set.seed(2003)
pvals500 <- replicate(2000, simulate_kw())
pvals300 <- replicate(2000, simulate_kw(n = 300))
pvals200 <- replicate(2000, simulate_kw(n = 200))
pvals100 <- replicate(2000, simulate_kw(n = 100))
```

```{r genplot}
#| echo: false
plot500 <- ggplot(data.frame(pvals = pvals500), aes(x = pvals)) +
  geom_density(fill = "steelblue", alpha = 0.4, lwd = 0.7) +
  geom_vline(xintercept = 0.05, linetype = "dashed") +
  labs(title = "n = 500", x = "p-value", y = "Density") +
  theme_minimal()

plot300 <- ggplot(data.frame(pvals = pvals300), aes(x = pvals)) +
  geom_density(fill = "steelblue", alpha = 0.4, lwd = 0.7) +
  geom_vline(xintercept = 0.05, linetype = "dashed") +
  labs(title = "n = 300", x = "p-value", y = "Density") +
  theme_minimal()

plot200 <- ggplot(data.frame(pvals = pvals200), aes(x = pvals)) +
  geom_density(fill = "steelblue", alpha = 0.4, lwd = 0.7) +
  geom_vline(xintercept = 0.05, linetype = "dashed") +
  labs(title = "n = 200", x = "p-value", y = "Density") +
  theme_minimal()

plot100 <- ggplot(data.frame(pvals = pvals100), aes(x = pvals)) +
  geom_density(fill = "steelblue", alpha = 0.4, lwd = 0.7) +
  geom_vline(xintercept = 0.05, linetype = "dashed") +
  labs(title = "n = 100", x = "p-value", y = "Density") +
  theme_minimal()
```

```{r combplot}
#| echo: false
combined_plot <- (plot500 | plot300) /
                 (plot200 | plot100)
                 
combined_plot + plot_annotation(title = "P-Value Density Plots Across Sample Sizes")

ggsave("combined_density_plots.pdf", combined_plot,
       width = 10, height = 8)
```

```{r rejrate}
#| echo: false

# Define a vector of different sample sizes to test.
n_vals <- c(20, 50, 100, 150, 200, 250, 300, 350, 400, 450, 500)
alpha <- 0.05

# Define a function to calculate the rejection rate for a given sample size.
rej_rate_n <- function(n, reps = 2000) {
  pvals <- replicate(reps, simulate_kw(n))
  mean(pvals < alpha) #estimated rejection rate
}

rejection_rates <- sapply(n_vals, rej_rate_n)

rej_table <- data.frame(
  n = n_vals,
  rejection_rate = rejection_rates
)

library(knitr)
kable(rej_table, digits = 3, caption = "Rejection Rates vs. Sample Size")
```

```{r rejplot}
#| echo: false
ggplot(rej_table, aes(x = n, y = rejection_rate)) +
  geom_line(lwd = 1.2, color = "steelblue") +
  geom_point(size = 3, color = "darkred") +
  scale_y_continuous(limits = c(0, 1)) +
  labs(
    title = "Rejection Rate vs Sample Size",
    x = "Sample size per group (n)",
    y = "Rejection Rate"
  ) +
  theme_minimal()
```

```{r metrics}
#| warning: false
#| echo: false
library(moments)

generate_groups <- function(n) {
  A <- rnorm(n) #normal distribution
  B_raw <- rlnorm(n)
  B <- B_raw - median(B_raw) + median(A) #lognormal distribution, shifted to match the median of A
  C_raw <- rt(n, df = 3)
  C <- C_raw - median(C_raw) + median(A) #t-distribution with 3 degrees of freedom, shifted to match the median of A

  data.frame(
    A = A,
    B = B,
    C = C
  )
}

n_values <- c(50, 100, 200, 300, 400, 500)

# Initialize an empty data frame to store results.
results <- data.frame()

# Loop over each sample size.
for(n in n_values) {
  groups <- generate_groups(n)

  # Compute skewness and kurtosis for each group.
  skew_vals <- sapply(groups, skewness)
  kurt_vals <- sapply(groups, kurtosis)

df <- data.frame(
  n = n,
  group = names(skew_vals),
  skewness = skew_vals,
  kurtosis = kurt_vals
  )

  results <- rbind(results, df)
}

library(kableExtra)

# Removing the "n" column for display purposes.
results_no_n <- subset(results, select = -n)

kable(
  results_no_n,
  caption = "Skewness and Kurtosis by Group and Sample Size",
  digits = 3, #round numbers to 3 decimal places
  booktabs = TRUE, #use LaTeX-style table formatting
  row.names = FALSE #remove doubled group names
) %>%
  kable_styling(latex_options = c("hold_position")) %>%
  # Group rows by sample size.
  group_rows("n = 50", 1, 3) %>%
  group_rows("n = 100", 4, 6) %>%
  group_rows("n = 200", 7, 9) %>%
  group_rows("n = 300", 10, 12) %>%
  group_rows("n = 400", 13, 15) %>%
  group_rows("n = 500", 16, 18)
```